---
- hosts: all
  tasks:
    - name: Save the output of the hostname command to the hostname variable
      ansible.builtin.shell: hostname
      register: hostname_cmd

    - name: Set fact with hostname
      set_fact:
        hostname_cmd: "{{ hostname_cmd.stdout }}"

- hosts: "{{ frontend_group | d('frontend') }}"
  roles:
    - role: test_vm
      when: validation.run_test_vm | d(true)
    - role: storage-benchmark
      when: validation.run_storage_benchmark | d(true)
  tasks:
    # Only execute these steps on a single frontend host
    - when: hostvars[groups[frontend_group | d('frontend')][0]]['ansible_host'] == ansible_host
      block:
        - name: Get list of OpenNebula host to "hostname_cmd" mapping
          shell: onehost list -j
          register: host_list_json
          changed_when: false
          no_log: true

        - name: Extract HOST raw (may be mapping or list)
          set_fact:
            host_raw: "{{ (host_list_json.stdout | from_json).HOST_POOL.HOST | default([]) }}"

        - name: Normalize HOST list (always a list)
          set_fact:
            host_list: "{{ [host_raw] if (host_raw is mapping) else (host_raw | default([])) }}"

        - name: Set fact with host to 'hostname_cmd' mapping
          set_fact:
            host_name_to_hostname_cmd: >-
              {{
                dict(
                  (host_list | map(attribute='NAME'))
                  | zip(
                      host_list
                      | map(attribute='TEMPLATE')
                      | map(attribute='HOSTNAME')
                    )
                )
              }}

# Run connectivity tests between virtual machines
- hosts: "{{ node_group | d('node') }},{{ frontend_group | d('frontend') }}"
  gather_facts: true
  roles:
    - role: conn_matrix
      when: validation.run_conn_matrix | d(true)

# Run network tests on the hypervisor hosts
- hosts: "{{ node_group | d('node') }}"
  roles:
    - role: network-benchmark

- ansible.builtin.import_playbook: ./vm-ha.yml

# Cleanup the test VMs
- hosts: "{{ frontend_group | d('frontend') }}"
  roles:
    - role: cleanup_test_vm

# Will launch validation framework on the frontends
- hosts: "{{ frontend_group | d('frontend') }}"
  roles:
    - role: validation


# Run FE HA verfification only when variable run_fe_ha is set to true
- hosts: "{{ frontend_group | d('frontend') }}"
  tasks:
    - name: Import fe-ha playbook
      import_playbook:
        name: fe-ha
      when: validation.run_fe_ha == true

# Render verification report
- hosts: localhost
  gather_facts: false
  become: false
  vars:
    verification_result: "{{ hostvars[groups[frontend_group | d('frontend')][0]].verification_result | default({'No verification results were found': 'N/A'})}}"
    date: "{{ lookup('pipe', 'date +%Y-%m-%d\\ %H:%M:%S') }}"
    validation_vars: "{{ hostvars[groups[frontend_group | d('frontend')][0]].validation | default({}) }}"
  tasks:
    - name: Get repository version
      ansible.builtin.shell: |
        git describe --tags --exact-match 2>/dev/null || git rev-parse --short HEAD
      args:
        chdir: "{{ playbook_dir }}/.."
      register: repo_version_cmd
      changed_when: false

    - name: Collect network benchmark results from node hosts
      # Build a map of node -> { iperf_results, ping_exec } so the report can render them
      ansible.builtin.set_fact:
        network_benchmark: "{{ network_benchmark | default({}) | combine({ item: {'iperf_results': hostvars[item].iperf_results | default(None), 'ping_exec': hostvars[item].ping_exec | default(None)} }) }}"
      loop: "{{ groups[node_group | d('node')] }}"
      loop_control:
        label: "{{ item }}"

    - name: Collect storage benchmark results from frontend hosts
      # Build a map of frontend -> { read, write } so the report can render them
      ansible.builtin.set_fact:
        storage_benchmark: "{{ storage_benchmark | default({}) | combine({ item: {'write': hostvars[item].write | default(None), 'read': hostvars[item].read | default(None)} }) }}"
      loop: "{{ groups[frontend_group | d('frontend')] }}"
      loop_control:
        label: "{{ item }}"

    - name: Build IP -> hostname mapping for report
      ansible.builtin.set_fact:
        ip_to_hostname: "{{ ip_to_hostname | default({}) | combine({ (hostvars[item].get('ansible_host')): item }) }}"
      loop: "{{ groups['all'] }}"
      when: hostvars[item].get('ansible_host', '') != ''
      loop_control:
        label: "{{ item }}"

    - name: Render report
      template:
        src: "appendix-cloud-report.j2"
        dest: /tmp/cloud_verification_report.html
      vars:
        repo_version: "{{ repo_version_cmd.stdout }}"
        # pass collected network benchmark results to the template
        network_benchmark: "{{ network_benchmark | default({}) }}"

    - name: Print report location
      ansible.builtin.debug:
        msg: |
          ******************************************************
          Verification report rendered to /tmp/cloud_verification_report.html
          ******************************************************

