---
- hosts: "{{ node_group | d('node') }}"
  gather_facts: true
  tasks:
    - name: Generate SSH key pair for conn-matrix
      ansible.builtin.command: ssh-keygen -t rsa -b 4096 -N "" -f $HOME/.ssh/conn-matrix -q
      args:
        creates: "{{ ansible_env.HOME }}/.ssh/conn-matrix"
    
    - name: Read public key
      ansible.builtin.slurp:
        src: "{{ ansible_env.HOME }}/.ssh/conn-matrix.pub"
      register: conn_matrix_pubkey_raw

    - name: Set fact with public key
      ansible.builtin.set_fact:
        conn_matrix_pubkey: "{{ conn_matrix_pubkey_raw['content'] | b64decode }}"

- name: Collect all public keys into a dictionary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Build dictionary of node public keys
      ansible.builtin.set_fact:
        conn_matrix_pubkeys: >-
            {{
              dict(
                hostvars
                | dict2items
                | selectattr('value.conn_matrix_pubkey', 'defined')
                | map(attribute='value.ansible_host')
                | zip(
                    hostvars
                    | dict2items
                    | selectattr('value.conn_matrix_pubkey', 'defined')
                    | map(attribute='value.conn_matrix_pubkey')
                  )
              )
            }}


- hosts: "{{ frontend_group | d('frontend') }}"
  tasks:
    # TODO: only on 1 frontend node if there is federation / HA
    - name: Get list of OpenNebula host IDs and names
      shell: onehost list -l ID,NAME --csv --no-header
      register: host_ids_and_names
      changed_when: false

    - name: Display host ID mapping to hostnames
      debug:
        msg: "Found OpenNebula hosts with IDs: {{ host_ids_and_names.stdout_lines }}"

    - name: Create a dedicated VM group and VM for each host
      ansible.builtin.include_tasks: tasks/conn_matrix_per_host.yml
      loop: "{{ host_ids_and_names.stdout_lines }}"

# TODO: perform the conn-matrix tests on the created VMs

    - name: Cleanup all created VM groups and VMs
      ansible.builtin.include_tasks: tasks/cleanup_conn_matrix_per_host.yml
      loop: "{{ host_ids_and_names.stdout_lines }}"
